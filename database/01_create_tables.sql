-- ðŸ“‹ ER DiyagramÄ± Revizyon Listesi (Notlar)
-- 1. ZayÄ±f VarlÄ±k (Weak Entity) DÃ¼zeltmesi:
-- Hata: Åžu anki diyagramda STOP (Durak) kutusu tek Ã§izgili bir dikdÃ¶rtgen olarak Ã§izilmiÅŸ.
-- DÃ¼zeltme: STOP kutusunun Ã§erÃ§evesi Ã‡ift Ã‡izgili DikdÃ¶rtgen yapÄ±lmalÄ±.
-- Nedeni: Duraklar, bir Rota (ROUTE) olmadan tek baÅŸlarÄ±na var olamazlar (Existence Dependency).

-- 2. TanÄ±mlayÄ±cÄ± Ä°liÅŸki (Identifying Relationship) DÃ¼zeltmesi:
-- Hata: ROUTE ile STOP arasÄ±ndaki Has (Sahip Olma) iliÅŸkisini gÃ¶steren baklava dilimi tek Ã§izgili.
-- DÃ¼zeltme: Has baklava diliminin Ã§erÃ§evesi Ã‡ift Ã‡izgili yapÄ±lmalÄ±.
-- Nedeni: Bu iliÅŸki, zayÄ±f varlÄ±ÄŸÄ± (Durak) gÃ¼Ã§lÃ¼ varlÄ±ÄŸa (Rota) baÄŸlayan "TanÄ±mlayÄ±cÄ± Ä°liÅŸki"dir.

-- 3. YazÄ±m HatasÄ± (Typo) DÃ¼zeltmesi:
-- Hata: Participations ile iliÅŸkili olan nitelik kutusunda is_complated yazÄ±yor.
-- DÃ¼zeltme: Kelime is_completed olarak dÃ¼zeltilmeli.
-- Nedeni: VeritabanÄ±ndaki sÃ¼tun adÄ± is_completed. Hem Ä°ngilizce doÄŸrusu bu, hem de kodla uyumlu olmalÄ±.


-- 1. Sequence OluÅŸturma (Proje Ä°steri: Sequence KullanÄ±mÄ±)
-- Bu sequence sadece participations tablosu iÃ§in kullanÄ±lacak.
-- Ã‡Ã¼nkÃ¼ bu tablo daha dinamik/deÄŸiÅŸkendir. 
-- id iÅŸlemleri(id sÄ±fÄ±rlama vs.) daha yoÄŸun gerÃ§ekleÅŸebileceÄŸi iÃ§in mantÄ±klÄ±dÄ±r
-- Eventler oluyor siliniyor katÄ±lÄ±mcÄ±lar deÄŸiÅŸiyor sonra id 100000 oluyor.
-- id 100000den sonra atÄ±yorum sÄ±fÄ±rdan tekrar baÅŸlatma fln saÄŸlarmÄ±ÅŸ.
CREATE SEQUENCE participations_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

-- 2. TablolarÄ±n OluÅŸturulmasÄ±

CREATE TABLE "users" (
  "user_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "username" varchar UNIQUE NOT NULL,
  "password" varchar NOT NULL,
  "role" varchar NOT NULL DEFAULT 'user',
  "total_points" integer DEFAULT 0,
  "created_at" timestamp DEFAULT (now()),
  -- Ä°ster: SayÄ± KÄ±sÄ±tÄ± (Puan negatif olamaz)
  CONSTRAINT check_positive_points CHECK (total_points >= 0)
);

CREATE TABLE "user_hobbies" (
  "hobby_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" integer,
  "hobby_name" varchar NOT NULL
);

CREATE TABLE "routes" (
  "route_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "creator_id" integer,
  "route_name" varchar NOT NULL,
  "distance_km" decimal NOT NULL,
  "difficulty_level" varchar,
  "created_at" timestamp DEFAULT (now()),
  -- Ä°ster: SayÄ± KÄ±sÄ±tÄ± (Mesafe 0 veya negatif olamaz)
  CONSTRAINT check_positive_distance CHECK (distance_km > 0)
);

CREATE TABLE "stops" (
  "stop_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "route_id" integer,
  "stop_order" integer NOT NULL,
  "location_name" varchar NOT NULL
);

CREATE TABLE "events" (
  "event_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "organizer_id" integer,
  "route_id" integer,
  "event_date" timestamp NOT NULL,
  "status" varchar DEFAULT 'active',
  "description" text,
  -- Ä°ster: Veri kÄ±sÄ±tÄ± (Sadece belirli durumlar girilebilir)
  CONSTRAINT check_event_status CHECK (status IN ('active', 'completed', 'cancelled'))
);

CREATE TABLE "participations" (
  -- Burada yukarÄ±da oluÅŸturduÄŸumuz Sequence'i kullanÄ±yoruz
  "participation_id" INTEGER DEFAULT nextval('participations_seq') PRIMARY KEY,
  "user_id" integer,
  "event_id" integer,
  "join_date" timestamp DEFAULT (now()),
  "is_completed" boolean DEFAULT false
);

-- 3. Foreign Key TanÄ±mlarÄ±

ALTER TABLE "user_hobbies" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("user_id") ON DELETE CASCADE;

ALTER TABLE "routes" ADD FOREIGN KEY ("creator_id") REFERENCES "users" ("user_id");

ALTER TABLE "stops" ADD FOREIGN KEY ("route_id") REFERENCES "routes" ("route_id") ON DELETE CASCADE;

ALTER TABLE "events" ADD FOREIGN KEY ("organizer_id") REFERENCES "users" ("user_id");

ALTER TABLE "events" ADD FOREIGN KEY ("route_id") REFERENCES "routes" ("route_id");

ALTER TABLE "participations" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("user_id");

ALTER TABLE "participations" ADD FOREIGN KEY ("event_id") REFERENCES "events" ("event_id") ON DELETE CASCADE;