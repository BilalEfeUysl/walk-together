{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

<style>
    #map { height: 600px; width: 100%; border-radius: 10px; }
    .route-card { cursor: pointer; transition: transform 0.2s; }
    .route-card:hover { transform: scale(1.02); background-color: #f0fdf4; }
    
    /* Yol tarifi metin kutusunu gizle (Sadece Ã§izgiyi gÃ¶ster) */
    .leaflet-routing-container {
        display: none !important;
    }
</style>

<div class="row">
    <div class="col-md-4" style="height: 600px; overflow-y: auto;">
        <h3 class="mb-3">ğŸ“ Rotalar</h3>
        <p class="text-muted small">DetaylÄ± yol Ã§izimi iÃ§in kutuya, yorumlar iÃ§in butona tÄ±klayÄ±n.</p>
        
        <div class="list-group">
            {% for route in routes %}
            
            <div class="list-group-item list-group-item-action route-card p-3 position-relative">
                
                <div onclick="drawRoadRoute('{{ loop.index }}')">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 fw-bold text-primary">{{ route[0] }}</h5>
                        <small class="text-muted fw-bold">{{ route[2] }} km</small>
                    </div>
                    <p class="mb-1">Zorluk: <span class="badge bg-secondary">{{ route[1] }}</span></p>
                    <small class="text-muted">â­ {{ route[5] }} Puan | ğŸ‘¤ {{ route[3] }}</small>
                </div>

                <div class="mt-3 text-end border-top pt-2">
                    <a href="/route/{{ loop.index }}" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-info-circle"></i> Ä°ncele & Yorumla
                    </a>
                </div>
                
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-8">
        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    // 1. HaritayÄ± BaÅŸlat (Ä°stanbul Merkezli)
    var map = L.map('map').setView([41.0082, 28.9784], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Python'dan gelen rota verileri (JSON FormatÄ±nda)
    var routesData = {{ map_data | safe }}; 
    var currentRoutingControl = null; // Åu an Ã§izili olan yol
    var currentMarkers = []; // Åu an ekrandaki pinler

    // 2. Fonksiyon: TÄ±klanan rotayÄ± sokaklara gÃ¶re Ã§iz
    function drawRoadRoute(index) {
        var coords = routesData[index];

        if (!coords || coords.length === 0) {
            alert("Bu rotanÄ±n koordinatlarÄ± bulunamadÄ± veya eksik!");
            return;
        }

        // Ã–nceki rotayÄ± temizle
        if (currentRoutingControl) {
            map.removeControl(currentRoutingControl);
        }
        // Ã–nceki pinleri temizle
        currentMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        currentMarkers = [];

        // KoordinatlarÄ± Leaflet formatÄ±na Ã§evir
        var waypoints = coords.map(function(point) {
            return L.latLng(point[0], point[1]);
        });

        // --- SOKAK TAKÄ°BÄ° YAPAN SÄ°HÄ°RLÄ° KOD (OSRM) ---
        currentRoutingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false, 
            addWaypoints: false,       
            draggableWaypoints: false, 
            fitSelectedRoutes: true,   // HaritayÄ± yola odakla
            show: false,               // YazÄ±lÄ± tarifi gizle
            lineOptions: {
                styles: [{color: 'blue', opacity: 0.7, weight: 6}] // Mavi kalÄ±n Ã§izgi
            },
            createMarker: function(i, wp, nWps) {
                // BaÅŸlangÄ±Ã§, BitiÅŸ ve Ara DuraklarÄ± isimlendir
                var text = (i === 0) ? "BaÅŸlangÄ±Ã§ ğŸš©" : (i === nWps - 1) ? "BitiÅŸ ğŸ" : "Durak " + (i + 1);
                var marker = L.marker(wp.latLng).bindPopup(text);
                currentMarkers.push(marker);
                return marker;
            }
        }).addTo(map);
    }
</script>
{% endblock %}